<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Incoming Count</title>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 flex">

  <!-- Sidebar -->
  <%- include('partials/sidebar') %>

  <!-- Main Content -->
  <div class="flex-1 p-6">
    <h1 class="text-2xl font-bold mb-4">ðŸ“‹ Incoming Count</h1>

    <!-- Waybill Dropdown -->
    <div class="mb-4">
      <label for="waybillSelect" class="block font-semibold mb-1">Select Waybill</label>
      <select id="waybillSelect" class="w-full border rounded p-2">
        <option value="">-- Select Waybill --</option>
        <% waybills.filter(wb => wb.status === "OPEN").forEach(wb => { %>
          <option value="<%= wb._id %>">
            <%= wb.waybillNo %> <%= wb.count %> <%= wb.uom %> - 
            <%= dayjs(wb.date).format("MMMM DD, YYYY") %>
          </option>
        <% }) %>
      </select>
    </div>

    <!-- Actual Counts Form -->
    <form id="actualCountForm" action="/incoming/count/save" method="POST">
      <input type="hidden" name="waybillId" id="waybillId">

      <div id="itemsContainer" class="space-y-6"></div>

      <button id="saveBtn" type="submit" disabled class="mt-4 bg-blue-600 text-white px-4 py-2 rounded opacity-50 cursor-not-allowed">
        Save Actual Counts
      </button>
    </form>
  </div>

  <!-- Script -->
  <script>
    const waybills = <%- JSON.stringify(waybills) %>;
    const waybillSelect = document.getElementById('waybillSelect');
    const itemsContainer = document.getElementById('itemsContainer');
    const waybillIdInput = document.getElementById('waybillId');
    const saveBtn = document.getElementById('saveBtn');

    waybillSelect.addEventListener('change', function() {
      const selectedId = this.value;
      itemsContainer.innerHTML = '';
      waybillIdInput.value = selectedId;

      // Disable save button if no waybill selected
      if (!selectedId) {
        saveBtn.disabled = true;
        saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
        return;
      } else {
        saveBtn.disabled = false;
        saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }

      const wb = waybills.find(w => w._id === selectedId);
      if (!wb || wb.status !== "OPEN") return; // ensure closed waybills not selectable

      wb.items.forEach(item => {
        const div = document.createElement('div');
        div.classList.add('bg-white', 'shadow', 'rounded', 'p-4');

        div.innerHTML = `
          <label class="font-semibold mb-2 block">${item.productName}</label>
          
          <div class="flex gap-4 items-start">
            <!-- Actual Count Input -->
            <div class="flex-1">
              <input
                type="text"
                name="counts[${item.productName}]"
                value="${item.actualCount || ''}"
                class="w-full border rounded p-2 mb-1"
                placeholder="Enter actual counts (comma or space separated)"
              >
              <span class="text-gray-700 font-medium">Total: <span class="totalCount">${item.actualCount || 0}</span></span>
            </div>

            <!-- Remark (Actual) -->
            <div class="flex-1/2">
              <textarea
                name="remarkActual[${item.productName}]"
                class="w-full border rounded p-2"
                placeholder="Enter remarks here..."
                rows="2"
              >${item.remarkActual || ''}</textarea>
            </div>
          </div>
        `;

        itemsContainer.appendChild(div);

        const input = div.querySelector('input');
        const totalSpan = div.querySelector('.totalCount');

        if (item.actualCount) totalSpan.textContent = item.actualCount;

        input.addEventListener('input', (e) => {
          e.target.value = e.target.value.replace(/\s+/g, ',');
          const numbers = e.target.value.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
          totalSpan.textContent = numbers.reduce((sum, val) => sum + val, 0);
        });
      });
    });
  </script>

</body>
</html>
